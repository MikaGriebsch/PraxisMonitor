<!DOCTYPE html>
<html>
<head>
    <title>Media Wall</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/video_player.css' %}">
</head>
<body>
    <div id="patient-alert-container">
        <div class="alert-content">
            <h1 id="patient-name-display"></h1>
            <p class="instruction-text">Bitte begeben Sie sich umgehend in <span id="room_num" class="room_num"></span></p>
        </div>
    </div>

    <video id="videoPlayer" controls autoplay muted style="display: none;">
        <source src="" type="video/mp4">
    </video>

    <img id="imagePlayer" style="display: none; width: 100%; height: 100%; object-fit: contain;" />

    <audio id="alertSound" src="{% static 'sounds/ping.mp3' %}"></audio>

    <script>
        // Konfiguration
        const config = {
            checkInterval: 1000,
            alertDuration: 5000
        };

        // Zustandsverwaltung
        let state = {
            currentTimeout: null,
            mediaTimeout: null,
            lastProcessedPatient: null,
            currentMedia: 0,
            media: [
                {% for media in media_items %}
                {
                    'url': '{{ media.media_file.url }}',
                    'type': '{{ media.media_type }}',
                    'duration': {{ media.display_duration }},
                    'title': '{{ media.title|escapejs }}'
                },
                {% endfor %}
            ],
            videoPlayer: document.getElementById('videoPlayer'),
            imagePlayer: document.getElementById('imagePlayer'),
            alertContainer: document.getElementById('patient-alert-container')
        };

        // Media-Initialisierung
        function initializeMedia() {
            if(state.media.length > 0) {
                playNext();
            }
        }

        function playNext() {
            if(state.media.length === 0) return;
            
            const currentMediaItem = state.media[state.currentMedia];
            
            // Verstecke beide Player
            state.videoPlayer.style.display = 'none';
            state.imagePlayer.style.display = 'none';
            
            // Stoppe aktuelles Video falls läuft
            state.videoPlayer.pause();
            
            // Lösche eventuellen Media-Timeout
            if(state.mediaTimeout) {
                clearTimeout(state.mediaTimeout);
                state.mediaTimeout = null;
            }
            
            if(currentMediaItem.type === 'video') {
                // Zeige Video
                state.videoPlayer.style.display = 'block';
                state.videoPlayer.src = currentMediaItem.url;
                state.videoPlayer.play().catch(() => {
                    state.videoPlayer.muted = true;
                    state.videoPlayer.play();
                });
            } else if(currentMediaItem.type === 'photo') {
                // Zeige Foto
                state.imagePlayer.style.display = 'block';
                state.imagePlayer.src = currentMediaItem.url;
                
                // Setze Timeout für Foto-Anzeigedauer
                state.mediaTimeout = setTimeout(() => {
                    goToNextMedia();
                }, currentMediaItem.duration * 1000);
            }
        }

        function goToNextMedia() {
            state.currentMedia = (state.currentMedia + 1) % state.media.length;
            playNext();
        }

        // Patientenstatus-Überprüfung
        async function checkActivePatient() {
            try {
                const response = await fetch("{% url 'monitor:active_patient' %}", {
                    headers: {
                        'X-CSRFToken': "{{ csrf_token }}"
                    }
                });

                const data = await response.json();
                const alertSound = document.getElementById('alertSound');

                if(data.active) {
                    const isNewPatient = data.id !== state.lastProcessedPatient?.id;
                    const isNewStatus = new Date(data.status_changed) > new Date(state.lastProcessedPatient?.status_changed || 0);

                    if(isNewPatient || isNewStatus) {
                        state.lastProcessedPatient = data;

                        // Pausiere aktuelles Media
                        state.videoPlayer.style.display = 'none';
                        state.imagePlayer.style.display = 'none';
                        state.videoPlayer.pause();
                        if(state.mediaTimeout) {
                            clearTimeout(state.mediaTimeout);
                            state.mediaTimeout = null;
                        }

                        state.alertContainer.style.display = 'flex';
                        document.getElementById('patient-name-display').textContent = data.name;
                        document.getElementById('room_num').textContent = data.room;

                        // Sound abspielen
                        alertSound.play().catch(error => console.log('Ton konnte nicht abgespielt werden:', error));

                        if(state.currentTimeout) clearTimeout(state.currentTimeout);

                        state.currentTimeout = setTimeout(() => {
                            state.alertContainer.style.display = 'none';
                            playNext(); // Setze Media fort
                        }, config.alertDuration);
                    }
                } else {
                    state.alertContainer.style.display = 'none';
                    if(state.videoPlayer.style.display === 'none' && state.imagePlayer.style.display === 'none') {
                        playNext(); // Setze Media fort
                    }
                }
            } catch(e) {
                console.error('Fehler:', e);
            }
        }

        // Initialisierung
        window.addEventListener('load', () => {
            initializeMedia();
            
            // Event Listener für Video-Ende
            state.videoPlayer.addEventListener('ended', goToNextMedia);
            
            setInterval(checkActivePatient, config.checkInterval);
        });
    </script>
</body>
</html>